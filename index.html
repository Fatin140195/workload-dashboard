<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickUp Multi-View Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .tab-btn { border-bottom: 2px solid transparent; transition: all 0.2s; padding: 1.25rem 0.5rem; color: #64748b; font-size: 0.875rem; font-weight: 500; }
        .tab-btn.active { border-bottom-color: #7c3aed; color: #7c3aed; font-weight: 700; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .progress-bar { height: 8px; border-radius: 4px; background: #f1f5f9; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease-out; }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 bg-gradient-to-tr from-purple-600 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-200">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold tracking-tight text-slate-900 leading-tight">Live Console</h1>
                        <p id="syncStatus" class="text-[10px] text-slate-400 font-medium uppercase tracking-widest italic">Syncing...</p>
                    </div>
                </div>
                <nav class="flex gap-8">
                    <button onclick="switchTab('mgmt')" id="btn-mgmt" class="tab-btn active">Management</button>
                    <button onclick="switchTab('plan')" id="btn-plan" class="tab-btn">Planning</button>
                    <button onclick="switchTab('client')" id="btn-client" class="tab-btn">Client Progress</button>
                    <button onclick="switchTab('delivery')" id="btn-delivery" class="tab-btn">Delivery</button>
                </nav>
                <button onclick="fetchRealData()" class="bg-slate-900 text-white text-xs px-4 py-2 rounded-lg hover:bg-slate-800 flex items-center gap-2">Sync</button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div id="loadingOverlay" class="fixed inset-0 bg-white/60 backdrop-blur-sm z-[60] flex items-center justify-center hidden">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
        </div>

        <section id="view-mgmt" class="tab-content space-y-6">
            <div class="glass-card p-4 flex gap-4">
                <input type="text" id="mgmtSearch" oninput="renderView('mgmt')" placeholder="Search..." class="flex-1 px-4 py-2 border rounded-lg text-sm bg-slate-50 outline-none">
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 h-80"><canvas id="chartStatus"></canvas></div>
                <div class="glass-card p-6 h-80"><canvas id="chartAssignee"></canvas></div>
            </div>
            <div class="glass-card overflow-hidden">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="px-6 py-4">Task</th><th class="px-6 py-4">Client</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Due</th></tr>
                    </thead>
                    <tbody id="mgmtTable" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </section>

        <section id="view-plan" class="tab-content hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 glass-card p-6 h-96"><canvas id="chartCapacity"></canvas></div>
                <div class="glass-card p-6 space-y-4" id="capacityList"></div>
            </div>
        </section>

        <section id="view-client" class="tab-content hidden grid grid-cols-1 md:grid-cols-3 gap-6" id="clientGrid"></section>
        <section id="view-delivery" class="tab-content hidden max-w-2xl mx-auto space-y-4" id="deliveryTimeline"></section>
    </main>

    <script>
        const WORKER_URL = "https://dashboard.fatin-rasyidah.workers.dev/";
        const DEV_CAPACITY = 32;
        let tasks = [];
        let charts = {};
        let currentTab = 'mgmt';

        async function fetchRealData() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const response = await fetch(WORKER_URL);
                const data = await response.json();
                
                tasks = data.tasks.map(t => {
    // 1. Get Client Name from Custom Fields
    const clientField = t.custom_fields?.find(f => f.name.toLowerCase().includes('client'));
    
    // 2. Get Hours (Try built-in Time Estimate first, then custom field)
    let hours = 0;
    if (t.time_estimate) {
        // ClickUp stores time_estimate in milliseconds
        hours = Math.round((t.time_estimate / 3600000) * 10) / 10; 
    } else {
        const hourField = t.custom_fields?.find(f => f.name.toLowerCase().includes('hour'));
        hours = parseFloat(hourField?.value) || 0;
    }

    return {
        name: t.name || "Untitled Task",
        client: clientField?.value || "Internal / No Client",
        assignee: t.assignees && t.assignees.length > 0 ? t.assignees[0].username : "Unassigned",
        status: t.status ? t.status.status : "Open",
        due: t.due_date ? new Date(parseInt(t.due_date)).toLocaleDateString() : "No Date",
        hours: hours,
        type: (t.name.toLowerCase().includes('milestone') || t.priority?.priority === 'urgent') ? 'Milestone' : 'Task'
    };
});
                document.getElementById('syncStatus').innerText = "Last Sync: " + new Date().toLocaleTimeString();
                renderView(currentTab);
            } catch (err) {
                document.getElementById('syncStatus').innerText = "Sync Failed";
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`btn-${tabId}`).classList.add('active');
            renderView(tabId);
        }

        function renderView(view) {
            if (view === 'mgmt') {
                const search = document.getElementById('mgmtSearch').value.toLowerCase();
                const filtered = tasks.filter(t => t.name.toLowerCase().includes(search));
                document.getElementById('mgmtTable').innerHTML = filtered.map(t => `
                    <tr><td class="px-6 py-4 font-medium">${t.name}</td><td class="px-6 py-4 text-slate-500">${t.client}</td><td class="px-6 py-4 text-xs font-bold">${t.status}</td><td class="px-6 py-4 text-slate-400">${t.due}</td></tr>
                `).join('');
                updateCharts(filtered);
            } else if (view === 'plan') {
                renderPlanning();
            } else if (view === 'client') {
                renderClientProgress();
            } else if (view === 'delivery') {
                renderDelivery();
            }
        }

        function updateCharts(data) {
            const stats = data.reduce((a, t) => { a[t.status] = (a[t.status]||0)+1; return a; }, {});
            const devs = data.reduce((a, t) => { a[t.assignee] = (a[t.assignee]||0)+1; return a; }, {});
            if(charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('chartStatus'), { type: 'doughnut', data: { labels: Object.keys(stats), datasets: [{ data: Object.values(stats), backgroundColor: ['#10b981','#f59e0b','#6366f1','#ef4444','#94a3b8'] }] }, options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Status Distribution' }}} });
            if(charts.dev) charts.dev.destroy();
            charts.dev = new Chart(document.getElementById('chartAssignee'), { type: 'bar', data: { labels: Object.keys(devs), datasets: [{ label: 'Tasks', data: Object.values(devs), backgroundColor: '#7c3aed' }] }, options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Tasks per Developer' }}} });
        }

        function renderPlanning() {
            const devHours = tasks.reduce((acc, t) => { acc[t.assignee] = (acc[t.assignee] || 0) + t.hours; return acc; }, {});
            const labels = Object.keys(devHours);
            const values = Object.values(devHours);
            if(charts.cap) charts.cap.destroy();
            charts.cap = new Chart(document.getElementById('chartCapacity'), { type: 'bar', data: { labels, datasets: [{ label: 'Used Hours', data: values, backgroundColor: '#7c3aed' }, { label: 'Limit', data: labels.map(() => DEV_CAPACITY), backgroundColor: '#f1f5f9' }] }, options: { maintainAspectRatio: false, indexAxis: 'y' } });
            document.getElementById('capacityList').innerHTML = labels.map(name => {
                const used = devHours[name];
                const perc = Math.min((used / DEV_CAPACITY) * 100, 100);
                return `<div class="space-y-1"><div class="flex justify-between text-xs font-bold"><span>${name}</span><span>${used}h / ${DEV_CAPACITY}h</span></div><div class="progress-bar"><div class="progress-fill ${used > DEV_CAPACITY ? 'bg-red-500' : 'bg-purple-600'}" style="width: ${perc}%"></div></div></div>`;
            }).join('');
        }

        function renderClientProgress() {
            const clients = [...new Set(tasks.map(t => t.client))];
            document.getElementById('view-client').innerHTML = clients.map(client => {
                const cTasks = tasks.filter(t => t.client === client);
                const done = cTasks.filter(t => t.status.toLowerCase().includes('done')).length;
                const progress = Math.round((done / cTasks.length) * 100) || 0;
                return `<div class="glass-card p-6 space-y-4"><div><h4 class="font-bold text-slate-900">${client}</h4><p class="text-xs text-slate-400">${cTasks.length} Tasks</p></div><div class="text-xl font-black text-purple-600">${progress}%</div><div class="progress-bar"><div class="progress-fill bg-emerald-500" style="width: ${progress}%"></div></div></div>`;
            }).join('');
        }

        function renderDelivery() {
            const milestones = tasks.filter(t => t.type === 'Milestone').sort((a,b) => new Date(a.due) - new Date(b.due));
            document.getElementById('deliveryTimeline').innerHTML = milestones.length ? milestones.map(m => `
                <div class="glass-card p-4 flex justify-between items-center"><div><div class="font-bold">${m.name}</div><div class="text-xs text-slate-500">${m.client}</div></div><div class="text-right text-xs font-bold">${m.due}</div></div>
            `).join('') : '<p class="text-center text-slate-400 py-10">No upcoming milestones</p>';
        }

        window.onload = fetchRealData;
    </script>
</body>
</html>

