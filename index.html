<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClickUp Sprint & Support Console</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    
    <!-- Firebase for PM Agreement Storage -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.db = null;
        window.pmDeadlines = {};
        
        window.getClientDocId = (name) => {
            return (name || "Unknown").trim().toLowerCase().replace(/[^a-z0-9]/g, '-');
        };

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'clickup-pm-console-v2';

        const initAuth = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const colRef = collection(window.db, 'artifacts', appId, 'public', 'data', 'clientAgreements');
                    onSnapshot(colRef, (snapshot) => {
                        snapshot.forEach(doc => {
                            window.pmDeadlines[doc.id] = doc.data().agreementDate;
                        });
                        if (window.tasks && window.tasks.length > 0) {
                            refreshActiveTab();
                        }
                    }, (err) => console.error("Sync Error:", err));
                }
            });
        };
        initAuth();

        window.saveAgreementDate = async (clientName, dateValue) => {
            if (!window.db) return;
            const docId = window.getClientDocId(clientName);
            try {
                await setDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'clientAgreements', docId), {
                    agreementDate: dateValue,
                    client: clientName,
                    updatedAt: new Date().toISOString()
                });
            } catch (e) { console.error("Save failed:", e); }
        };

        function refreshActiveTab() {
            if (window.currentTab === 'client') renderClientProgress(window.currentFilteredTasks || window.tasks);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .tab-btn { border-bottom: 2px solid transparent; transition: all 0.2s; padding: 1.25rem 0.5rem; color: #64748b; font-size: 0.8rem; font-weight: 600; cursor: pointer; text-transform: uppercase; letter-spacing: 0.025em; }
        .tab-btn.active { border-bottom-color: #7c3aed; color: #7c3aed; font-weight: 800; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.show { display: flex; }
        .filter-content { display: none; position: absolute; background: white; min-width: 240px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); z-index: 50; border: 1px solid #e2e8f0; border-radius: 0.75rem; max-height: 350px; overflow-y: auto; padding: 10px; margin-top: 5px; }
        .filter-content.show { display: block; }
        .filter-item { display: flex; align-items: center; padding: 8px; font-size: 0.8125rem; cursor: pointer; border-radius: 0.375rem; transition: background 0.2s; user-select: none; }
        .filter-item:hover { background: #f8fafc; }
        .filter-item input { margin-right: 10px; accent-color: #7c3aed; width: 16px; height: 16px; pointer-events: none; }
        
        .st-badge { font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 3px 10px; border-radius: 6px; display: inline-block; white-space: nowrap; }
        .st-deployed { background: #00A884; color: white; }
        .st-pendingdeployment, .st-pendingdeployement { background: #D33131; color: white; }
        .st-test { background: #00B8D9; color: white; }
        .st-inreview { background: #6E5DC6; color: white; }
        .st-rework { background: #FFCC00; color: #4b3f00; }
        .st-inprogress { background: #0084FF; color: white; }
        .st-kiv { background: #FF7A00; color: white; }
        .st-todo { background: #D9D9D9; color: #475569; }
        .st-closed { background: #2ecc71; color: white; }
        .st-default { background: #f1f5f9; color: #64748b; }
        
        .progress-bar { height: 8px; border-radius: 4px; background: #f1f5f9; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .cursor-pointer-hover:hover { cursor: pointer; border-color: #7c3aed; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .alert-pulse { animation: pulse-red 2s infinite; }
    </style>
</head>
<body class="antialiased">

    <!-- DRILL-DOWN POPUP -->
    <div id="taskListModal" class="modal-overlay" onclick="closeAllModals(event)">
        <div class="glass-card w-full max-w-6xl max-h-[90vh] flex flex-col overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-extrabold text-slate-800" id="listModalTitle">Details</h2>
                    <span id="listModalCounter" class="text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1 rounded-full">0</span>
                </div>
                <button onclick="closeModal('taskListModal')" class="text-slate-400 hover:text-slate-600 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"></path></svg></button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/3 border-r border-slate-100 bg-slate-50/20 p-6 flex flex-col">
                    <h3 id="modalChartLabel" class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest text-center">Status Mix</h3>
                    <div class="flex-1 relative min-h-[300px]"><canvas id="modalChart"></canvas></div>
                </div>
                <div class="w-2/3 flex flex-col bg-white overflow-y-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white text-slate-500 sticky top-0 z-10 border-b">
                            <tr><th class="px-6 py-4 font-bold uppercase tracking-wider">Task</th><th class="px-6 py-4 font-bold uppercase tracking-wider">Sprint</th><th class="px-6 py-4 font-bold uppercase tracking-wider" id="listModalCol3">Info</th></tr>
                        </thead>
                        <tbody id="listModalTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div id="taskDetailModal" class="modal-overlay" onclick="closeAllModals(event)">
        <div class="glass-card w-full max-w-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                <h2 class="text-lg font-bold text-slate-800">Task Overview</h2>
                <button onclick="closeModal('taskDetailModal')" class="text-slate-400 hover:text-slate-600 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" stroke-width="2"></path></svg></button>
            </div>
            <div class="p-8 space-y-6 bg-white" id="detailContent"></div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg"><svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" stroke-width="2"></path></svg></div>
                <div><h1 class="text-lg font-bold">Live Console</h1><p id="syncStatus" class="text-[10px] text-slate-400 font-bold uppercase tracking-widest italic">Awaiting Sync</p></div>
            </div>
            <nav class="flex gap-4">
                <div onclick="switchTab('mgmt')" id="btn-mgmt" class="tab-btn active">Management</div>
                <div onclick="switchTab('plan')" id="btn-plan" class="tab-btn">Planning</div>
                <div onclick="switchTab('client')" id="btn-client" class="tab-btn">Client Progress</div>
                <div onclick="switchTab('unassigned')" id="btn-unassigned" class="tab-btn">Unassigned</div>
                <div onclick="switchTab('no-deadline')" id="btn-no-deadline" class="tab-btn">No Deadline</div>
                <div onclick="switchTab('backlog')" id="btn-backlog" class="tab-btn">Backlog</div>
            </nav>
            <button onclick="fetchRealData()" class="bg-slate-900 text-white text-xs px-5 py-2.5 rounded-lg font-bold hover:bg-slate-800 transition-all">Sync Now</button>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto px-4 py-8">
        <div id="loadingOverlay" class="fixed inset-0 bg-white/60 backdrop-blur-sm z-[60] flex items-center justify-center hidden"><div class="w-10 h-10 border-4 border-purple-600 border-t-transparent rounded-full animate-spin"></div></div>

        <!-- MANAGEMENT VIEW -->
        <section id="view-mgmt" class="tab-content space-y-6">
            <div class="glass-card p-4 flex flex-wrap gap-3 items-center bg-slate-50/50">
                <input type="text" id="mgmtSearch" oninput="renderView('mgmt')" placeholder="Search tasks..." class="flex-1 min-w-[200px] px-4 py-2 text-sm bg-white border rounded-lg outline-none">
                <div class="filter-dropdown"><button onclick="toggleFilterMenu(event, 'filterClientContent')" class="bg-white border px-4 py-2 rounded-lg text-sm min-w-[150px] text-left flex justify-between items-center"><span id="labelClient">All Clients</span><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg></button><div id="filterClientContent" class="filter-content" onclick="event.stopPropagation()"></div></div>
                <div class="filter-dropdown"><button onclick="toggleFilterMenu(event, 'filterAssigneeContent')" class="bg-white border px-4 py-2 rounded-lg text-sm min-w-[150px] text-left flex justify-between items-center"><span id="labelAssignee">All Assignees</span><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg></button><div id="filterAssigneeContent" class="filter-content" onclick="event.stopPropagation()"></div></div>
                <div class="filter-dropdown"><button onclick="toggleFilterMenu(event, 'filterSprintContent')" class="bg-white border px-4 py-2 rounded-lg text-sm min-w-[150px] text-left flex justify-between items-center"><span id="labelSprint">All Sprints</span><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg></button><div id="filterSprintContent" class="filter-content" onclick="event.stopPropagation()"></div></div>
                <div class="filter-dropdown"><button onclick="toggleFilterMenu(event, 'filterStatusContent')" class="bg-white border px-4 py-2 rounded-lg text-sm min-w-[150px] text-left flex justify-between items-center"><span id="labelStatus">All Statuses</span><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg></button><div id="filterStatusContent" class="filter-content" onclick="event.stopPropagation()"></div></div>
                <button onclick="resetFilters()" class="text-xs font-bold text-slate-400 hover:text-purple-600 uppercase ml-2">Reset</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-card p-6 h-96 relative"><h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Status Distribution</h3><div class="h-64"><canvas id="chartStatus"></canvas></div></div>
                <div class="glass-card p-6 h-96 relative"><h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Dev Workload</h3><div class="h-64"><canvas id="chartAssignee"></canvas></div></div>
            </div>
            <div class="glass-card overflow-hidden"><div class="px-6 py-4 border-b border-slate-100 bg-white flex justify-between items-center"><h3 class="text-xs font-bold uppercase text-slate-400">Inventory</h3><span id="taskCounter" class="text-xs font-bold bg-slate-100 px-3 py-1 rounded-full">0</span></div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-semibold border-b"><tr><th class="px-6 py-4">Task Name</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Sprint</th><th class="px-6 py-4">Assignee</th></tr></thead><tbody id="mgmtTable" class="divide-y divide-slate-100 bg-white"></tbody></table></div>
        </section>

        <!-- PLANNING VIEW -->
        <section id="view-plan" class="tab-content hidden space-y-6">
            <div id="planSummary" class="grid grid-cols-1 md:grid-cols-4 gap-6"></div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 glass-card p-6 h-96 relative"><h3 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Resource Capacity</h3><div class="h-64"><canvas id="chartCapacity"></canvas></div></div>
                <div class="glass-card p-6 space-y-6 overflow-y-auto max-h-[24rem]" id="capacityList"></div>
            </div>
        </section>

        <!-- CLIENT VIEW -->
        <section id="view-client" class="tab-content hidden grid grid-cols-1 md:grid-cols-3 gap-6" id="clientGrid"></section>

        <!-- UNASSIGNED VIEW -->
        <section id="view-unassigned" class="tab-content hidden space-y-6">
            <div class="glass-card overflow-hidden"><div class="px-6 py-4 border-b border-slate-100 bg-white flex justify-between items-center"><h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest text-orange-600 italic">Attention Required: Unassigned Work</h3><span id="unassignedCounter" class="text-xs font-black bg-orange-100 text-orange-600 px-3 py-1 rounded-full">0</span></div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-semibold border-b"><tr><th class="px-6 py-4">Task Name</th><th class="px-6 py-4">Sprint</th><th class="px-6 py-4">Client</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Urgency</th></tr></thead><tbody id="unassignedTable" class="divide-y divide-slate-100 bg-white"></tbody></table></div>
        </section>

        <!-- NO DEADLINE VIEW -->
        <section id="view-no-deadline" class="tab-content hidden space-y-6">
            <div class="glass-card overflow-hidden"><div class="px-6 py-4 border-b border-slate-100 bg-white flex justify-between items-center"><h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Tasks Without Deadlines</h3><span id="noDeadlineCounter" class="text-xs font-black bg-blue-100 text-blue-600 px-3 py-1 rounded-full">0</span></div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-semibold border-b"><tr><th class="px-6 py-4">Task Name</th><th class="px-6 py-4">Sprint</th><th class="px-6 py-4">Client</th><th class="px-6 py-4">Status</th><th class="px-6 py-4">Assignee</th></tr></thead><tbody id="noDeadlineTable" class="divide-y divide-slate-100 bg-white"></tbody></table></div>
        </section>

        <!-- BACKLOG VIEW -->
        <section id="view-backlog" class="tab-content hidden space-y-6">
            <div class="glass-card overflow-hidden"><div class="px-6 py-4 border-b border-slate-100 bg-white flex justify-between items-center"><h3 class="text-xs font-bold uppercase text-slate-400 tracking-widest">Backlog / Project Docs</h3><span id="backlogCounter" class="text-xs font-black bg-slate-100 text-slate-600 px-3 py-1 rounded-full">0</span></div><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-semibold border-b"><tr><th class="px-6 py-4">Requirement / Task Name</th><th class="px-6 py-4">Sprint</th><th class="px-6 py-4">Client</th><th class="px-6 py-4">Status</th></tr></thead><tbody id="backlogTable" class="divide-y divide-slate-100 bg-white"></tbody></table></div>
        </section>
    </main>

    <script>
        Chart.register(ChartDataLabels);
        window.tasks = [];
        window.currentFilteredTasks = [];
        let charts = {};
        window.currentTab = 'mgmt';
        const DEV_CAPACITY = 32;
        let activeFilters = { clients: [], assignees: [], statuses: [], sprints: [] };

        const STATUS_COLORS = { 
            'deployed': '#00A884', 
            'pendingdeployment': '#D33131', 
            'pendingdeployement': '#D33131', 
            'test': '#00B8D9', 
            'inreview': '#6E5DC6', 
            'rework': '#FFCC00', 
            're-work': '#FFCC00',
            'inprogress': '#0084FF', 
            'kiv': '#FF7A00', 
            'todo': '#D9D9D9', 
            'closed': '#2ecc71' 
        };
        function getStatusColor(key) { return STATUS_COLORS[key] || '#94a3b8'; }

        async function fetchRealData() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const response = await fetch("https://dashboard.fatin-rasyidah.workers.dev/");
                const json = await response.json();
                window.tasks = json.tasks.map(t => {
                    const clientField = t.custom_fields?.find(f => f.name.toLowerCase().includes('client'));
                    let clientName = "Internal";
                    if (clientField?.value !== undefined && clientField.type_config?.options) {
                        const opt = clientField.type_config.options.find(o => String(o.id) === String(clientField.value) || String(o.orderindex) === String(clientField.value));
                        clientName = opt ? (opt.label || opt.name) : clientField.value;
                    }
                    const rawStatus = t.status?.status || "todo";
                    const statusKey = rawStatus.toLowerCase().replace(/[\s]/g, '');
                    return {
                        id: t.id, name: t.name, url: t.url, client: clientName, assignee: t.assignees?.[0]?.username || "Unassigned",
                        status: t.status.status, statusKey: statusKey, sprint: t.list?.name || "Global",
                        category: (t.list?.name || "").toLowerCase().includes('support') ? "Support" : "Sprint",
                        hours: t.time_estimate ? Math.round(t.time_estimate / 3600000 * 10) / 10 : 0,
                        isClosed: (statusKey === 'deployed' || statusKey === 'closed' || t.status?.type === 'closed'),
                        dueDate: t.due_date ? new Date(parseInt(t.due_date)) : null,
                        priority: t.priority?.priority || "None"
                    };
                });
                document.getElementById('syncStatus').innerText = `Sync: ${new Date().toLocaleTimeString()} (${window.tasks.length} items)`;
                populateFilters();
                renderView(window.currentTab); 
            } catch (err) { console.error(err); }
            finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
        }

        function toggleFilterMenu(e, id) { e.stopPropagation(); document.querySelectorAll('.filter-content').forEach(c => { if(c.id !== id) c.classList.remove('show'); }); document.getElementById(id).classList.toggle('show'); }
        function populateFilters() {
            const sortedAssignees = [...new Set(window.tasks.map(t => t.assignee))].sort((a,b) => a === "Unassigned" ? -1 : (b === "Unassigned" ? 1 : a.localeCompare(b)));
            const sortedClients = [...new Set(window.tasks.map(t => t.client))].sort();
            const configs = { filterClientContent: { items: sortedClients, key: 'clients', label: 'labelClient', title: 'Clients' }, filterAssigneeContent: { items: sortedAssignees, key: 'assignees', label: 'labelAssignee', title: 'Assignees' }, filterSprintContent: { items: [...new Set(window.tasks.map(t => t.sprint))].sort(), key: 'sprints', label: 'labelSprint', title: 'Sprints' }, filterStatusContent: { items: [...new Set(window.tasks.map(t => t.status))].sort(), key: 'statuses', label: 'labelStatus', title: 'Statuses' } };
            Object.keys(configs).forEach(id => {
                const cfg = configs[id];
                document.getElementById(id).innerHTML = cfg.items.map(item => `<div class="filter-item" onclick="toggleSelection(event, '${cfg.key}', '${item.replace(/'/g, "\\'")}', '${cfg.label}', '${cfg.title}')"><input type="checkbox" ${activeFilters[cfg.key].includes(item) ? 'checked' : ''}><span class="truncate">${item}</span></div>`).join('');
            });
        }
        function toggleSelection(e, key, val, labelId, title) { const idx = activeFilters[key].indexOf(val); if (idx === -1) activeFilters[key].push(val); else activeFilters[key].splice(idx, 1); const label = document.getElementById(labelId); label.innerText = activeFilters[key].length === 0 ? `All ${title}` : (activeFilters[key].length === 1 ? activeFilters[key][0] : `${activeFilters[key].length} selected`); e.currentTarget.querySelector('input').checked = activeFilters[key].includes(val); renderView(window.currentTab); }
        function resetFilters() { activeFilters = { clients: [], assignees: [], statuses: [], sprints: [] }; ['labelClient', 'labelAssignee', 'labelSprint', 'labelStatus'].forEach(id => document.getElementById(id).innerText = `All ${id.replace('label', '')}s`); populateFilters(); renderView(window.currentTab); }

        function switchTab(tabId) { window.currentTab = tabId; document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(`view-${tabId}`).classList.remove('hidden'); document.getElementById(`btn-${tabId}`).classList.add('active'); renderView(tabId); }
        
        function renderView(view) {
            const search = document.getElementById('mgmtSearch').value.toLowerCase();
            window.currentFilteredTasks = window.tasks.filter(t => (activeFilters.clients.length === 0 || activeFilters.clients.includes(t.client)) && (activeFilters.assignees.length === 0 || activeFilters.assignees.includes(t.assignee)) && (activeFilters.sprints.length === 0 || activeFilters.sprints.includes(t.sprint)) && (activeFilters.statuses.length === 0 || activeFilters.statuses.includes(t.status)) && (t.name.toLowerCase().includes(search)));
            
            if (view === 'mgmt') {
                document.getElementById('taskCounter').innerText = window.currentFilteredTasks.length;
                document.getElementById('mgmtTable').innerHTML = window.currentFilteredTasks.map(t => `<tr class="hover:bg-slate-50 cursor-pointer" onclick="openTaskDetail('${t.id}')"><td class="px-6 py-4 font-bold text-slate-800">${t.name}</td><td class="px-6 py-4"><span class="st-badge st-${t.statusKey}">${t.status}</span></td><td class="px-6 py-4 text-slate-500 font-medium">${t.sprint}</td><td class="px-6 py-4 text-slate-500 font-medium">${t.assignee}</td></tr>`).join('') || '<tr><td colspan="4" class="p-10 text-center text-slate-400">No tasks.</td></tr>';
                renderCharts(window.currentFilteredTasks);
            } else if (view === 'plan') renderPlanning(window.currentFilteredTasks);
            else if (view === 'client') renderClientProgress(window.currentFilteredTasks);
            else if (view === 'unassigned') renderUnassigned(window.currentFilteredTasks);
            else if (view === 'no-deadline') renderNoDeadline(window.currentFilteredTasks);
            else if (view === 'backlog') renderBacklog(window.currentFilteredTasks);
        }

        function renderCharts(data) {
            const sMap = data.reduce((a, t) => { a[t.status] = (a[t.status]||0)+1; return a; }, {});
            const dMap = data.reduce((a, t) => { a[t.assignee] = (a[t.assignee]||0)+1; return a; }, {});
            if(charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('chartStatus'), { type: 'doughnut', data: { labels: Object.keys(sMap), datasets: [{ data: Object.values(sMap), backgroundColor: Object.keys(sMap).map(s => getStatusColor(s.toLowerCase().replace(/[\s-]/g, ''))) }] }, options: { maintainAspectRatio: false, onClick: (e, i) => { if(i.length > 0) openDrillDownPopup(charts.status.data.labels[i[0].index], 'status'); }, plugins: { legend: { display: false }, datalabels: { color: '#fff', font: { weight: 'bold', size: 10 }, formatter: (v, ctx) => { let sum = 0; ctx.chart.data.datasets[0].data.map(d => sum += d); return (v*100/sum).toFixed(0)+"%"; } } } } });
            if(charts.dev) charts.dev.destroy();
            charts.dev = new Chart(document.getElementById('chartAssignee'), { type: 'bar', data: { labels: Object.keys(dMap), datasets: [{ label: 'Tasks', data: Object.values(dMap), backgroundColor: '#7c3aed', borderRadius: 4 }] }, options: { maintainAspectRatio: false, onClick: (e, i) => { if(i.length > 0) openDrillDownPopup(charts.dev.data.labels[i[0].index], 'assignee'); }, plugins: { legend: { display: false }, datalabels: { display: false } } } });
        }

        function openDrillDownPopup(val, type) {
            document.getElementById('listModalTitle').innerText = val;
            document.getElementById('modalChartLabel').innerText = `${type.toUpperCase()} DRILLDOWN`;
            renderModalChart(type, val);
            refreshDrillDownList(type, val);
            document.getElementById('taskListModal').classList.add('show');
        }
        function renderModalChart(type, initial) {
            const set = window.tasks.filter(t => (type === 'client' ? t.client === initial : (type === 'assignee' ? t.assignee === initial : true)));
            const map = set.reduce((a, t) => { const k = t.status; a[k] = (a[k]||0)+1; return a; }, {});
            if (charts.modal) charts.modal.destroy();
            charts.modal = new Chart(document.getElementById('modalChart'), { type: 'doughnut', data: { labels: Object.keys(map), datasets: [{ data: Object.values(map), backgroundColor: Object.keys(map).map(s => getStatusColor(s.toLowerCase().replace(/[\s-]/g, ''))) }] }, options: { maintainAspectRatio: false, onClick: (e, i) => { if (i.length > 0) refreshDrillDownList(type, initial, charts.modal.data.labels[i[0].index]); }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } }, datalabels: { color: '#fff', formatter: (v, ctx) => { let s = 0; ctx.chart.data.datasets[0].data.map(d => s += d); return (v*100/s).toFixed(0)+"%"; } } } } });
        }
        function refreshDrillDownList(type, val, sub = null) {
            let f = [];
            if (type === 'client') f = window.tasks.filter(t => t.client === val && (sub ? t.status === sub : true));
            else if (type === 'assignee') f = window.tasks.filter(t => t.assignee === val && (sub ? t.status === sub : true));
            else f = window.tasks.filter(t => t.status === val);
            document.getElementById('listModalCounter').innerText = f.length;
            document.getElementById('listModalTableBody').innerHTML = f.map(t => `<tr class="hover:bg-slate-50 cursor-pointer" onclick="openTaskDetail('${t.id}')"><td class="px-6 py-4"><div class="font-bold">${t.name}</div><div class="text-[10px] text-slate-400 uppercase font-bold">${t.client}</div></td><td class="px-6 py-4 text-slate-500">${t.sprint}</td><td class="px-6 py-4"><span class="st-badge st-${t.statusKey}">${t.status}</span></td></tr>`).join('');
        }

        function openTaskDetail(id) {
            const t = window.tasks.find(x => x.id === id); if (!t) return;
            document.getElementById('detailContent').innerHTML = `
                <div><h3 class="text-2xl font-black text-slate-900">${t.name}</h3><div class="text-[10px] font-bold text-purple-600 uppercase mt-2">${t.category}</div></div>
                <div class="grid grid-cols-2 gap-6 py-4 border-y border-slate-50">
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Status</p><span class="st-badge st-${t.statusKey}">${t.status}</span></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Assignee</p><p class="font-bold text-slate-700">${t.assignee}</p></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Sprint</p><p class="font-medium text-slate-600">${t.sprint}</p></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Client</p><p class="font-bold text-slate-700">${t.client}</p></div>
                    <div class="col-span-2"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Due Date</p><p class="font-bold text-slate-900">${t.dueDate ? t.dueDate.toLocaleDateString() : 'No Deadline'}</p></div>
                </div>
                <div class="flex justify-between items-center pt-2"><div class="text-sm italic">Estimated: ${t.hours}h</div><a href="${t.url}" target="_blank" class="bg-slate-900 text-white px-6 py-2.5 rounded-lg font-bold text-xs flex items-center gap-2">Open in ClickUp <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke-width="2"></path></svg></a></div>`;
            document.getElementById('taskDetailModal').classList.add('show');
        }

        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function closeAllModals(e) { if(e.target.classList.contains('modal-overlay')) document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show')); }
        window.addEventListener('click', (e) => { if(!e.target.closest('.filter-dropdown')) document.querySelectorAll('.filter-content').forEach(c => c.classList.remove('show')); });

        function renderPlanning(data) {
            const total = data.reduce((s, t) => s + t.hours, 0);
            document.getElementById('planSummary').innerHTML = `<div class="glass-card p-6 flex flex-col items-center col-span-full"><h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Selected Load</h3><div class="text-4xl font-black">${total.toFixed(1)}h</div></div>`;
            const devHrs = data.reduce((acc, t) => { acc[t.assignee] = (acc[t.assignee] || 0) + t.hours; return acc; }, {});
            const labels = Object.keys(devHrs);
            if(charts.plan) charts.plan.destroy();
            charts.plan = new Chart(document.getElementById('chartCapacity'), { type: 'bar', data: { labels, datasets: [{ label: 'Hours', data: Object.values(devHrs), backgroundColor: '#7c3aed', borderRadius: 4 }, { label: 'Limit', data: labels.map(() => DEV_CAPACITY), backgroundColor: '#f1f5f9' }] }, options: { maintainAspectRatio: false, indexAxis: 'y', onClick: (e, i) => { if(i.length > 0) openDrillDownPopup(charts.plan.data.labels[i[0].index], 'assignee'); }, plugins: { datalabels: { display: false } } } });
            document.getElementById('capacityList').innerHTML = labels.map(n => { const u = devHrs[n], p = Math.min((u/DEV_CAPACITY)*100, 100); return `<div class="space-y-1"><div class="flex justify-between text-xs font-bold"><span>${n}</span><span>${u.toFixed(1)}h / ${DEV_CAPACITY}h</span></div><div class="progress-bar"><div class="progress-fill ${u > DEV_CAPACITY ? 'bg-red-500' : 'bg-purple-600'}" style="width: ${p}%"></div></div></div>`; }).join('');
        }

        function renderClientProgress(data) {
            const clients = [...new Set(data.map(t => t.client))];
            const now = new Date();
            document.getElementById('view-client').innerHTML = clients.map(c => {
                const ct = data.filter(t => t.client === c);
                const done = ct.filter(t => t.isClosed).length;
                const prog = ct.length > 0 ? Math.round((done / ct.length) * 100) : 0;
                const remaining = ct.length - done;
                const agreementStr = window.pmDeadlines[window.getClientDocId(c)] || "";
                const agreementDate = agreementStr ? new Date(agreementStr) : null;
                const taskDeadlines = ct.map(t => t.dueDate).filter(d => d !== null);
                const latestTaskDeadline = taskDeadlines.length > 0 ? new Date(Math.max(...taskDeadlines)) : null;
                let healthColor = "text-slate-400"; let healthLabel = "No Agreement";
                if (agreementDate) {
                    const diff = agreementDate - now; const diffDays = Math.ceil(diff / (1000 * 60 * 60 * 24));
                    if (remaining > 0 && diffDays < 0) { healthColor = "text-red-600 font-black"; healthLabel = "OVERDUE"; }
                    else if (remaining > 0 && diffDays <= 7) { healthColor = "text-orange-500 font-bold"; healthLabel = `Due in ${diffDays}d`; }
                    else { healthColor = "text-emerald-600 font-bold"; healthLabel = "On Track"; }
                    if (latestTaskDeadline && latestTaskDeadline > agreementDate && remaining > 0) { healthColor = "text-red-700 font-black underline"; healthLabel = "RISK: TASK > AGREEMENT"; }
                }
                return `<div class="glass-card p-6 space-y-4 cursor-pointer-hover flex flex-col" onclick="openDrillDownPopup('${c.replace(/'/g, "\\'")}', 'client')">
                    <div class="flex justify-between items-start"><h4 class="font-bold text-slate-800 leading-tight">${c}</h4><span class="text-xl font-black text-purple-600">${prog}%</span></div>
                    <div class="space-y-2" onclick="event.stopPropagation()">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Agreement Date</p>
                        <input type="date" value="${agreementStr}" onchange="saveAgreementDate('${c}', this.value)" class="w-full text-xs p-1 border rounded bg-slate-50 focus:bg-white transition-all outline-none">
                    </div>
                    <div class="flex justify-between text-[10px] uppercase font-bold"><span class="${healthColor}">${healthLabel}</span><span class="text-slate-400">Items: ${remaining} left</span></div>
                    <div class="progress-bar"><div class="progress-fill ${prog === 100 ? 'bg-emerald-500' : 'bg-purple-600'}" style="width: ${prog}%"></div></div>
                </div>`;
            }).join('');
        }

        function renderUnassigned(data) {
            const unassigned = data.filter(t => t.assignee === "Unassigned");
            document.getElementById('unassignedCounter').innerText = unassigned.length;
            document.getElementById('unassignedTable').innerHTML = unassigned.map(t => `<tr class="hover:bg-slate-50 cursor-pointer" onclick="openTaskDetail('${t.id}')"><td class="px-6 py-4 font-bold text-slate-800 flex items-center gap-2">${t.name} <span class="bg-red-500 text-white text-[8px] px-1 rounded alert-pulse">ATTENTION</span></td><td class="px-6 py-4 text-slate-500">${t.sprint}</td><td class="px-6 py-4 text-slate-500">${t.client}</td><td class="px-6 py-4"><span class="st-badge st-${t.statusKey}">${t.status}</span></td><td class="px-6 py-4 font-bold uppercase text-[10px] text-red-500">${t.priority}</td></tr>`).join('') || '<tr><td colspan="5" class="p-10 text-center text-slate-400">All tasks assigned.</td></tr>';
        }

        function renderNoDeadline(data) {
            const list = data.filter(t => !t.dueDate);
            document.getElementById('noDeadlineCounter').innerText = list.length;
            document.getElementById('noDeadlineTable').innerHTML = list.map(t => `<tr class="hover:bg-slate-50 cursor-pointer" onclick="openTaskDetail('${t.id}')"><td class="px-6 py-4 font-bold text-slate-800">${t.name}</td><td class="px-6 py-4 text-slate-500">${t.sprint}</td><td class="px-6 py-4 text-slate-500">${t.client}</td><td class="px-6 py-4"><span class="st-badge st-${t.statusKey}">${t.status}</span></td><td class="px-6 py-4 text-slate-500">${t.assignee}</td></tr>`).join('') || '<tr><td colspan="5" class="p-10 text-center text-slate-400">All tasks have deadlines.</td></tr>';
        }

        function renderBacklog(data) {
            const list = data.filter(t => t.sprint.toLowerCase().includes('backlog') || t.status.toLowerCase().includes('backlog'));
            document.getElementById('backlogCounter').innerText = list.length;
            document.getElementById('backlogTable').innerHTML = list.map(t => `<tr class="hover:bg-slate-50 cursor-pointer" onclick="openTaskDetail('${t.id}')"><td class="px-6 py-4 font-bold text-slate-800">${t.name}</td><td class="px-6 py-4 text-slate-500">${t.sprint}</td><td class="px-6 py-4 text-slate-500">${t.client}</td><td class="px-6 py-4"><span class="st-badge st-${t.statusKey}">${t.status}</span></td></tr>`).join('') || '<tr><td colspan="4" class="p-10 text-center text-slate-400">Backlog is empty.</td></tr>';
        }

        window.onload = fetchRealData;
    </script>
</body>
</html>
